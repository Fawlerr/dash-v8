<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates - Dashboard WhatsApp</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="/css/sidebar-styles.css">
    <script src="/js/sidebar-loader.js"></script>
    <!-- Efeitos tecnológicos -->
    <link rel="stylesheet" href="/css/tech-effects.css">
    <script src="/js/tech-effects.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; color: #ffffff; margin: 0; padding: 0; }
        
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background: #111827; border-right: 1px solid #374151; z-index: 1000; transition: transform 0.3s ease-in-out; }
        .sidebar-hidden { transform: translateX(-100%); }
        .main-content { margin-left: 250px; min-height: 100vh; padding: 20px; transition: margin-left 0.3s ease-in-out; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; display: none; }
        .sidebar-item { display: flex; align-items: center; padding: 12px 16px; color: #d1d5db; text-decoration: none; transition: all 0.2s ease; border-radius: 8px; margin: 4px 12px; }
        .sidebar-item:hover { background: #374151; color: #ffffff; }
        .sidebar-item i { width: 20px; height: 20px; margin-right: 12px; color: #9ca3af; }
        .sidebar-item:hover i { color: #ffffff; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #374151; display: flex; align-items: center; justify-content: space-between; }
        .sidebar-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; border-top: 1px solid #374151; }
        .logout-btn { width: 100%; display: flex; align-items: center; justify-content: center; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s ease; }
        .logout-btn:hover { background: #b91c1c; }
        .mobile-menu-btn { display: none; position: fixed; top: 20px; left: 20px; z-index: 1001; background: #374151; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); }
        .controls { background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; }
        .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .template-card { 
            background: rgba(15, 15, 35, 0.8); 
            border-radius: 12px; 
            padding: 20px; 
            border: 1px solid rgba(139, 92, 246, 0.3); 
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.5s ease;
        }
        .template-card:hover::before {
            left: 100%;
        }
        .template-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(139, 92, 246, 0.3),
                0 0 40px rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.6);
        }
        .template-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .template-name { font-weight: 600; color: #ffffff; font-size: 1.1rem; }
        .template-media { display: flex; align-items: center; font-size: 0.8rem; color: #8b5cf6; background: rgba(139, 92, 246, 0.1); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(139, 92, 246, 0.3); }
        .template-preview { background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .template-message { color: #d1d5db; line-height: 1.5; margin-bottom: 10px; }
        .template-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
        .template-button { background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 6px; padding: 4px 8px; font-size: 0.8rem; color: #00d4ff; }
        .template-actions { display: flex; gap: 8px; margin-top: 15px; }
        .action-btn { flex: 1; padding: 8px 12px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; color: #00d4ff; cursor: pointer; transition: all 0.3s ease; font-size: 0.8rem; text-align: center; }
        .action-btn:hover { background: rgba(0, 212, 255, 0.2); transform: translateY(-1px); }
        .delete-btn { background: rgba(255, 71, 87, 0.1) !important; border-color: rgba(255, 71, 87, 0.3) !important; color: #ff4757 !important; }
        .delete-btn:hover { background: rgba(255, 71, 87, 0.2) !important; border-color: rgba(255, 71, 87, 0.5) !important; transform: translateY(-1px); }
        .edit-btn { background: rgba(255, 193, 7, 0.1) !important; border-color: rgba(255, 193, 7, 0.3) !important; color: #ffc107 !important; }
        .edit-btn:hover { background: rgba(255, 193, 7, 0.2) !important; border-color: rgba(255, 193, 7, 0.5) !important; transform: translateY(-1px); }
        
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #0099cc); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, #0099cc, #007aa3); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #ffffff; border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; font-weight: 600; }
        .btn-success:hover { background: linear-gradient(135deg, #00cc6a, #00aa55); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1f2937; border-radius: 12px; padding: 0; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #374151; }
        .modal-header h3 { color: #ffffff; font-size: 1.5rem; margin: 0; }
        .close-modal { background: none; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.3s ease; }
        .close-modal:hover { background: rgba(255, 255, 255, 0.1); color: #ffffff; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #ffffff; font-size: 0.9rem; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; background: #374151; border: 1px solid #4b5563; border-radius: 8px; color: #ffffff; font-size: 0.9rem; transition: all 0.3s ease; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-group input::placeholder, .form-group textarea::placeholder { color: #9ca3af; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .required { color: #ef4444; }
        
        /* Estilos para seção de mídia */
        .media-section {
            margin-top: 10px;
        }

        .media-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .media-type-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .media-type-option input[type="radio"] {
            display: none;
        }

        .media-type-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            background: rgba(26, 26, 46, 0.5);
            color: #e5e7eb;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .media-type-option input[type="radio"]:checked + .media-type-label {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .media-type-option:hover .media-type-label {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(139, 92, 246, 0.05);
        }

        .file-upload-area {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(26, 26, 46, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(139, 92, 246, 0.05);
        }

        .file-upload-area.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .file-upload-content p {
            color: #9ca3af;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .select-file-btn {
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .select-file-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .media-preview-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(26, 26, 46, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            margin-top: 16px;
        }

        .media-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .media-filename {
            color: #ffffff;
            font-weight: 500;
            font-size: 14px;
        }

        .media-size {
            color: #9ca3af;
            font-size: 12px;
        }

        .remove-media-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-media-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .button-block { background: #374151; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #4b5563; }
        .button-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .button-block-title { color: #ffffff; font-size: 0.9rem; font-weight: 500; }
        .remove-button { background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .remove-button:hover { background: #dc2626; }
        .add-button { background: #6b7280; color: white; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
        .add-button:hover { background: #9ca3af; }
        .modal-footer { padding: 20px; border-top: 1px solid #374151; display: flex; gap: 15px; justify-content: flex-end; }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 60px 20px 20px; }
            .mobile-menu-btn { display: block; }
            .sidebar-overlay.show { display: block; }
            .templates-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Sidebar será carregada dinamicamente pelo sidebar-loader.js -->

    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-file-text"></i> Gerenciamento de Templates</h1>
                <p>Sistema de Templates - <span id="totalTemplates">0</span> Templates</p>
            </div>

            <div class="controls">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary" onclick="refreshTemplates()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                    <button class="btn btn-warning" onclick="resetTemplates()" style="background: #f59e0b; border-color: #f59e0b;">
                        <i class="fas fa-trash-restore"></i> Reset
                    </button>
                </div>
                <button class="btn btn-success" onclick="openNewTemplateModal()">
                    <i class="fas fa-plus"></i> Novo Template
                </button>
            </div>

            <div id="loadingIndicator" class="loading" style="text-align: center; padding: 50px; color: #b8b8b8;">
                <i class="fas fa-spinner" style="font-size: 3rem; margin-bottom: 20px; animation: spin 1s linear infinite;"></i>
                <p>Carregando templates...</p>
            </div>

            <div id="templatesContent" style="display: none;">
                <div class="templates-grid" id="templatesGrid">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar novo template -->
    <div class="modal" id="newTemplateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Template</h3>
                <button class="close-modal" onclick="closeNewTemplateModal()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newTemplateForm">
                    <div class="form-group">
                        <label for="templateName">Nome do Template <span class="required">*</span></label>
                        <input type="text" id="templateName" name="templateName" placeholder="Ex: Boas-vindas" required>
                    </div>
                    <div class="form-group">
                        <label for="templateTitle">Título da Mensagem</label>
                        <input type="text" id="templateTitle" name="templateTitle" placeholder="Ex: Bem-vindo ao nosso serviço">
                    </div>
                    <div class="form-group">
                        <label for="templateMessage">Texto da Mensagem <span class="required">*</span></label>
                        <textarea id="templateMessage" name="templateMessage" placeholder="Digite o texto da mensagem..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="templateFooter">Rodapé da Mensagem</label>
                        <input type="text" id="templateFooter" name="templateFooter" placeholder="Ex: Obrigado por escolher nossos serviços">
                    </div>

                    <!-- Seção de Configuração de Perfil -->
                    <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 20px; margin-top: 20px;">
                        <h4 style="color: #8b5cf6; margin-bottom: 15px; font-size: 1.1rem;">
                            <i class="fas fa-user-circle" style="margin-right: 8px;"></i>
                            Configuração de Perfil (Opcional)
                        </h4>
                        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 15px;">
                            Configure o perfil do WhatsApp que será aplicado automaticamente quando este template for usado.
                        </p>
                        
                        <div class="form-group">
                            <label for="templateProfileName">Nome do Perfil</label>
                            <input type="text" id="templateProfileName" name="templateProfileName" placeholder="Ex: Sua Empresa" maxlength="25">
                            <small style="color: #9ca3af; font-size: 0.8rem;">Máximo 25 caracteres</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="templateProfilePhoto">URL da Foto de Perfil</label>
                            <input type="url" id="templateProfilePhoto" name="templateProfilePhoto" placeholder="https://exemplo.com/foto.jpg">
                            <small style="color: #9ca3af; font-size: 0.8rem;">URL da imagem para foto de perfil</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="templateProfileBio">Biografia do Perfil</label>
                            <textarea id="templateProfileBio" name="templateProfileBio" placeholder="Ex: Sua biografia aqui..." maxlength="139" rows="3"></textarea>
                            <small style="color: #9ca3af; font-size: 0.8rem;">Máximo 139 caracteres</small>
                        </div>
                    </div>

                    <!-- Seção de Mídia -->
                    <div class="form-group">
                        <label>Mídia (Opcional)</label>
                        <div class="media-section">
                            <div class="media-type-selector">
                                <label class="media-type-option">
                                    <input type="radio" name="mediaType" value="none" checked>
                                    <span class="media-type-label">
                                        <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
                                        Sem mídia
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="mediaType" value="image">
                                    <span class="media-type-label">
                                        <i data-lucide="image" style="width: 20px; height: 20px;"></i>
                                        Imagem
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="mediaType" value="image-url">
                                    <span class="media-type-label">
                                        <i data-lucide="link" style="width: 20px; height: 20px;"></i>
                                        URL da Imagem
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="mediaType" value="audio">
                                    <span class="media-type-label">
                                        <i data-lucide="music" style="width: 20px; height: 20px;"></i>
                                        Áudio
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="mediaType" value="video">
                                    <span class="media-type-label">
                                        <i data-lucide="video" style="width: 20px; height: 20px;"></i>
                                        Vídeo
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="mediaType" value="document">
                                    <span class="media-type-label">
                                        <i data-lucide="file" style="width: 20px; height: 20px;"></i>
                                        Documento
                                    </span>
                                </label>
                            </div>
                            
                            <div id="mediaUploadSection" style="display: none;">
                                <div class="file-upload-area" id="fileUploadArea">
                                    <div class="file-upload-content">
                                        <i data-lucide="upload" style="width: 48px; height: 48px; color: #8b5cf6; margin-bottom: 16px;"></i>
                                        <p>Arraste e solte o arquivo aqui ou clique para selecionar</p>
                                        <input type="file" id="mediaFile" name="mediaFile" accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;">
                                        <button type="button" class="select-file-btn" onclick="document.getElementById('mediaFile').click()">
                                            Selecionar Arquivo
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="mediaPreview" style="display: none;">
                                    <div class="media-preview-content">
                                        <div class="media-info">
                                            <span class="media-filename" id="mediaFilename"></span>
                                            <span class="media-size" id="mediaSize"></span>
                                        </div>
                                        <button type="button" class="remove-media-btn" onclick="removeMedia()">
                                            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="mediaUrlSection" style="display: none;">
                                <div class="form-group">
                                    <label for="mediaUrl">URL da Imagem:</label>
                                    <input type="url" id="mediaUrl" name="mediaUrl" placeholder="https://exemplo.com/imagem.jpg" class="form-control">
                                    <small class="form-text text-muted">Cole aqui a URL da imagem que deseja usar</small>
                                </div>
                                <div id="mediaUrlPreview" style="display: none;">
                                    <div class="media-preview-content">
                                        <img id="mediaUrlImage" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                                        <button type="button" class="remove-media-btn" onclick="removeMediaUrl()">
                                            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="buttonsContainer">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label>Botões da Mensagem</label>
                            <button type="button" class="add-button" onclick="addButton()">
                                <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 5px;"></i>
                                Adicionar Botão
                            </button>
                        </div>
                        <div id="buttonsList">
                            <!-- Botões serão adicionados dinamicamente aqui -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeNewTemplateModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Salvar Template</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar template -->
    <div class="modal" id="editTemplateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Template</h3>
                <button class="close-modal" onclick="closeEditTemplateModal()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTemplateForm">
                    <input type="hidden" id="editTemplateId">
                    <div class="form-group">
                        <label for="editTemplateName">Nome do Template <span class="required">*</span></label>
                        <input type="text" id="editTemplateName" name="editTemplateName" placeholder="Ex: Boas-vindas" required>
                    </div>
                    <div class="form-group">
                        <label for="editTemplateTitle">Título da Mensagem</label>
                        <input type="text" id="editTemplateTitle" name="editTemplateTitle" placeholder="Ex: Bem-vindo ao nosso serviço">
                    </div>
                    <div class="form-group">
                        <label for="editTemplateMessage">T
                            
                            exto da Mensagem <span class="required">*</span></label>
                        <textarea id="editTemplateMessage" name="editTemplateMessage" placeholder="Digite o texto da mensagem..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTemplateFooter">Rodapé da Mensagem</label>
                        <input type="text" id="editTemplateFooter" name="editTemplateFooter" placeholder="Ex: Obrigado por escolher nossos serviços">
                    </div>

                    <!-- Seção de Configuração de Perfil -->
                    <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 20px; margin-top: 20px;">
                        <h4 style="color: #8b5cf6; margin-bottom: 15px; font-size: 1.1rem;">
                            <i class="fas fa-user-circle" style="margin-right: 8px;"></i>
                            Configuração de Perfil (Opcional)
                        </h4>
                        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 15px;">
                            Configure o perfil do WhatsApp que será aplicado automaticamente quando este template for usado.
                        </p>
                        
                        <div class="form-group">
                            <label for="editTemplateProfileName">Nome do Perfil</label>
                            <input type="text" id="editTemplateProfileName" name="editTemplateProfileName" placeholder="Ex: Sua Empresa" maxlength="25">
                            <small style="color: #9ca3af; font-size: 0.8rem;">Máximo 25 caracteres</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTemplateProfilePhoto">URL da Foto de Perfil</label>
                            <input type="url" id="editTemplateProfilePhoto" name="editTemplateProfilePhoto" placeholder="https://exemplo.com/foto.jpg">
                            <small style="color: #9ca3af; font-size: 0.8rem;">URL da imagem para foto de perfil</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTemplateProfileBio">Biografia do Perfil</label>
                            <textarea id="editTemplateProfileBio" name="editTemplateProfileBio" placeholder="Ex: Sua biografia aqui..." maxlength="139" rows="3"></textarea>
                            <small style="color: #9ca3af; font-size: 0.8rem;">Máximo 139 caracteres</small>
                        </div>
                    </div>

                    <!-- Seção de Mídia -->
                    <div class="form-group">
                        <label>Mídia (Opcional)</label>
                        <div class="media-section">
                            <div class="media-type-selector">
                                <label class="media-type-option">
                                    <input type="radio" name="editMediaType" value="none" checked>
                                    <span class="media-type-label">
                                        <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
                                        Sem mídia
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="editMediaType" value="image">
                                    <span class="media-type-label">
                                        <i data-lucide="image" style="width: 20px; height: 20px;"></i>
                                        Imagem
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="editMediaType" value="image-url">
                                    <span class="media-type-label">
                                        <i data-lucide="link" style="width: 20px; height: 20px;"></i>
                                        URL da Imagem
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="editMediaType" value="audio">
                                    <span class="media-type-label">
                                        <i data-lucide="music" style="width: 20px; height: 20px;"></i>
                                        Áudio
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="editMediaType" value="video">
                                    <span class="media-type-label">
                                        <i data-lucide="video" style="width: 20px; height: 20px;"></i>
                                        Vídeo
                                    </span>
                                </label>
                                <label class="media-type-option">
                                    <input type="radio" name="editMediaType" value="document">
                                    <span class="media-type-label">
                                        <i data-lucide="file" style="width: 20px; height: 20px;"></i>
                                        Documento
                                    </span>
                                </label>
                            </div>
                            
                            <div id="editMediaUploadSection" style="display: none;">
                                <div class="file-upload-area" id="editFileUploadArea">
                                    <div class="file-upload-content">
                                        <i data-lucide="upload" style="width: 48px; height: 48px; color: #8b5cf6; margin-bottom: 16px;"></i>
                                        <p>Arraste e solte o arquivo aqui ou clique para selecionar</p>
                                        <input type="file" id="editMediaFile" name="editMediaFile" accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;">
                                        <button type="button" class="select-file-btn" onclick="document.getElementById('editMediaFile').click()">
                                            Selecionar Arquivo
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="editMediaPreview" style="display: none;">
                                    <div class="media-preview-content">
                                        <div class="media-info">
                                            <span class="media-filename" id="editMediaFilename"></span>
                                            <span class="media-size" id="editMediaSize"></span>
                                        </div>
                                        <button type="button" class="remove-media-btn" onclick="removeEditMedia()">
                                            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="editMediaUrlSection" style="display: none;">
                                <div class="form-group">
                                    <label for="editMediaUrl">URL da Imagem:</label>
                                    <input type="url" id="editMediaUrl" name="editMediaUrl" placeholder="https://exemplo.com/imagem.jpg" class="form-control">
                                    <small class="form-text text-muted">Cole aqui a URL da imagem que deseja usar</small>
                                </div>
                                <div id="editMediaUrlPreview" style="display: none;">
                                    <div class="media-preview-content">
                                        <img id="editMediaUrlImage" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                                        <button type="button" class="remove-media-btn" onclick="removeEditMediaUrl()">
                                            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="editButtonsContainer">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label>Botões da Mensagem</label>
                            <button type="button" class="add-button" onclick="addEditButton()">
                                <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 5px;"></i>
                                Adicionar Botão
                            </button>
                        </div>
                        <div id="editButtonsList">
                            <!-- Botões serão adicionados dinamicamente aqui -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditTemplateModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="updateTemplate()">Atualizar Template</button>
            </div>
        </div>
    </div>


    <script>
        let templatesData = [];

        // Inicializar ícones do Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Sidebar functionality será gerenciada pelo sidebar-loader.js

        // Load templates data
        async function loadTemplates() {
            console.log('Carregando templates...');
            
            try {
                // Load templates from API
                const response = await fetch('/api/templates');
                if (response.ok) {
                    const data = await response.json();
                    templatesData = data.templates || [];
                    console.log('Templates carregados da API:', templatesData.length);
                    updateTemplatesGrid(templatesData);
                    updateStats(templatesData.length);
                    hideLoading();
                    return;
                } else {
                    console.error('Erro na API:', response.status, response.statusText);
                    throw new Error(`API Error: ${response.status}`);
                }
            } catch (error) {
                console.error('Erro ao carregar templates da API:', error);
                
                // Fallback: try localStorage
                const localTemplates = localStorage.getItem('templates');
                if (localTemplates) {
                    console.log('Usando templates do localStorage como fallback');
                    try {
                        const data = JSON.parse(localTemplates);
                        templatesData = data.templates || [];
                        console.log('Templates carregados do localStorage:', templatesData.length);
                        updateTemplatesGrid(templatesData);
                        updateStats(templatesData.length);
                        hideLoading();
                        return;
                    } catch (e) {
                        console.error('Erro ao parsear localStorage:', e);
                        localStorage.removeItem('templates');
                    }
                }
                
                // Final fallback: use embedded templates
                console.log('Usando templates embarcados como último recurso');
                templatesData = defaultTemplates.templates || [];
                
                // Save to localStorage for next time
                localStorage.setItem('templates', JSON.stringify(defaultTemplates));
                console.log('Templates padrão salvos no localStorage:', templatesData.length);
                
                updateTemplatesGrid(templatesData);
                updateStats(templatesData.length);
                hideLoading();
            }
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('templatesContent').style.display = 'block';
        }

        function updateStats(totalTemplates) {
            document.getElementById('totalTemplates').textContent = totalTemplates;
        }

        function updateTemplatesGrid(templates) {
            const grid = document.getElementById('templatesGrid');
            grid.innerHTML = '';

            if (templates.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: #9ca3af;">
                        <i data-lucide="file-text" style="width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3>Nenhum template encontrado</h3>
                        <p>Clique em "Novo Template" para criar seu primeiro template</p>
                    </div>
                `;
                return;
            }

            templates.forEach((template, index) => {
                const card = document.createElement('div');
                card.className = 'template-card';

                const buttonsHtml = template.buttons && template.buttons.length > 0 
                    ? template.buttons.map(btn => `<span class="template-button">${escapeHtml(btn.label)} (ID: ${btn.id})</span>`).join('')
                    : '';

                // Media info
                const mediaInfo = template.media?.type ? `
                    <div class="template-media">
                        <i data-lucide="${getMediaIcon(template.media.type)}" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                        <span>${getMediaTypeLabel(template.media.type)}</span>
                        ${template.media.filename ? `<span style="color: #9ca3af; margin-left: 8px;">(${template.media.filename})</span>` : ''}
                    </div>
                ` : '';

                // Profile info
                const profileInfo = template.profile && (template.profile.name || template.profile.photo || template.profile.bio) ? `
                    <div class="template-media" style="background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3); color: #8b5cf6; margin-top: 8px;">
                        <i class="fas fa-user-circle" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                        <span>Perfil: ${template.profile.name || 'Sem nome'}</span>
                        ${template.profile.photo ? `<span style="color: #9ca3af; margin-left: 8px;">(Foto configurada)</span>` : ''}
                    </div>
                ` : '';

                card.innerHTML = `
                    <div class="template-header">
                        <div class="template-name">${escapeHtml(template.name)}</div>
                        ${mediaInfo}
                    </div>
                    ${profileInfo}
                    
                    <div class="template-preview">
                        ${template.title ? `<div style="font-weight: 600; color: #ffffff; margin-bottom: 8px;">${escapeHtml(template.title)}</div>` : ''}
                        <div class="template-message">${escapeHtml(template.message)}</div>
                        ${template.footer ? `<div style="font-size: 0.8rem; color: #9ca3af; margin-top: 8px;">${escapeHtml(template.footer)}</div>` : ''}
                        ${buttonsHtml ? `<div class="template-buttons">${buttonsHtml}</div>` : ''}
                    </div>

                    <div class="template-actions">
                        <button class="action-btn edit-btn" onclick="editTemplate('${template.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn delete-btn" onclick="confirmDeleteTemplate('${template.id}', '${escapeHtml(template.name)}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function goBack() {
            window.location.href = '/dashboard.html';
        }

        function refreshTemplates() {
            loadTemplates();
        }

        function resetTemplates() {
            if (confirm('Tem certeza que deseja resetar os templates?\n\nIsso irá:\n- Limpar o localStorage\n- Recarregar os templates da API\n- Perder qualquer template criado localmente')) {
                localStorage.removeItem('templates');
                console.log('localStorage limpo');
                loadTemplates();
                showNotification('Templates resetados com sucesso!', 'success');
            }
        }

        // Template data for modal
        let templateData = {
            name: '',
            title: '',
            message: '',
            footer: '',
            media: {
                type: null,
                url: null,
                filename: null,
                size: null
            },
            buttons: [],
            profile: {
                name: '',
                photo: '',
                bio: ''
            }
        };

        // Modal functions
        function openNewTemplateModal() {
            // Reset form data
            templateData = {
                name: '',
                title: '',
                message: '',
                footer: '',
                media: {
                    type: null,
                    url: null,
                    filename: null,
                    size: null
                },
                buttons: [],
                profile: {
                    name: '',
                    photo: '',
                    bio: ''
                }
            };
            
            // Reset form fields
            document.getElementById('templateName').value = '';
            document.getElementById('templateTitle').value = '';
            document.getElementById('templateMessage').value = '';
            document.getElementById('templateFooter').value = '';
            document.getElementById('templateProfileName').value = '';
            document.getElementById('templateProfilePhoto').value = '';
            document.getElementById('templateProfileBio').value = '';
            document.getElementById('buttonsList').innerHTML = '';
            
            // Reset media fields
            document.querySelector('input[name="mediaType"][value="none"]').checked = true;
            document.getElementById('mediaFile').value = '';
            document.getElementById('mediaUploadSection').style.display = 'none';
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('fileUploadArea').style.display = 'block';
            
            document.getElementById('newTemplateModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeNewTemplateModal() {
            document.getElementById('newTemplateModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Button management functions
        function addButton() {
            const buttonId = Date.now();
            templateData.buttons.push({
                id: buttonId,
                type: 'REPLY',
                label: '',
                url: ''
            });
            renderButtons();
        }

        function removeButton(buttonId) {
            templateData.buttons = templateData.buttons.filter(btn => btn.id !== buttonId);
            renderButtons();
        }

        // Media management functions
        function handleMediaTypeChange() {
            const mediaType = document.querySelector('input[name="mediaType"]:checked').value;
            const uploadSection = document.getElementById('mediaUploadSection');
            const urlSection = document.getElementById('mediaUrlSection');
            const preview = document.getElementById('mediaPreview');
            const urlPreview = document.getElementById('mediaUrlPreview');
            
            if (mediaType === 'none') {
                uploadSection.style.display = 'none';
                urlSection.style.display = 'none';
                preview.style.display = 'none';
                urlPreview.style.display = 'none';
            } else if (mediaType === 'image-url') {
                uploadSection.style.display = 'none';
                urlSection.style.display = 'block';
                preview.style.display = 'none';
                urlPreview.style.display = 'none';
            } else {
                uploadSection.style.display = 'block';
                urlSection.style.display = 'none';
                preview.style.display = 'none';
                urlPreview.style.display = 'none';
            }
        }

        function handleEditMediaTypeChange() {
            const mediaType = document.querySelector('input[name="editMediaType"]:checked').value;
            console.log('🔄 Tipo de mídia alterado para:', mediaType);
            const uploadSection = document.getElementById('editMediaUploadSection');
            const urlSection = document.getElementById('editMediaUrlSection');
            const preview = document.getElementById('editMediaPreview');
            const urlPreview = document.getElementById('editMediaUrlPreview');
            
            console.log('🔄 Elementos encontrados:', {
                uploadSection: !!uploadSection,
                urlSection: !!urlSection,
                preview: !!preview,
                urlPreview: !!urlPreview
            });
            
            if (mediaType === 'none') {
                console.log('🔄 Ocultando seções de mídia');
                if (uploadSection) uploadSection.style.display = 'none';
                if (urlSection) urlSection.style.display = 'none';
                if (preview) preview.style.display = 'none';
                if (urlPreview) urlPreview.style.display = 'none';
            } else if (mediaType === 'image-url') {
                console.log('🔄 Mostrando seção de URL');
                if (uploadSection) uploadSection.style.display = 'none';
                if (urlSection) urlSection.style.display = 'block';
                if (preview) preview.style.display = 'none';
                if (urlPreview) urlPreview.style.display = 'none';
            } else {
                console.log('🔄 Mostrando seção de upload');
                if (uploadSection) uploadSection.style.display = 'block';
                if (urlSection) urlSection.style.display = 'none';
                if (preview) preview.style.display = 'none';
                if (urlPreview) urlPreview.style.display = 'none';
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                showMediaPreview(file, false);
            }
        }

        function handleEditFileSelect(event) {
            console.log('📎 Arquivo selecionado para edição:', event.target.files[0]);
            const file = event.target.files[0];
            if (file) {
                console.log('📎 Mostrando preview do arquivo:', file.name, file.size);
                showMediaPreview(file, true);
            }
        }

        function showMediaPreview(file, isEdit = false) {
            console.log('🖼️ Mostrando preview:', { file: file.name, isEdit });
            const filename = isEdit ? 'editMediaFilename' : 'mediaFilename';
            const size = isEdit ? 'editMediaSize' : 'mediaSize';
            const preview = isEdit ? 'editMediaPreview' : 'mediaPreview';
            
            console.log('🖼️ Elementos DOM:', { filename, size, preview });
            
            document.getElementById(filename).textContent = file.name;
            document.getElementById(size).textContent = formatFileSize(file.size);
            document.getElementById(preview).style.display = 'block';
            
            // Hide upload area
            const uploadArea = isEdit ? 'editFileUploadArea' : 'fileUploadArea';
            document.getElementById(uploadArea).style.display = 'none';
            
            console.log('🖼️ Preview configurado com sucesso');
        }

        function removeMedia() {
            document.getElementById('mediaFile').value = '';
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('fileUploadArea').style.display = 'block';
        }

        function removeMediaUrl() {
            document.getElementById('mediaUrl').value = '';
            document.getElementById('mediaUrlPreview').style.display = 'none';
        }

        function removeEditMediaUrl() {
            document.getElementById('editMediaUrl').value = '';
            document.getElementById('editMediaUrlPreview').style.display = 'none';
        }

        function removeEditMedia() {
            document.getElementById('editMediaFile').value = '';
            document.getElementById('editMediaPreview').style.display = 'none';
            document.getElementById('editFileUploadArea').style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getMediaIcon(type) {
            const icons = {
                'image': 'image',
                'audio': 'music',
                'video': 'video',
                'document': 'file'
            };
            return icons[type] || 'file';
        }

        function getMediaTypeLabel(type) {
            const labels = {
                'image': 'Imagem',
                'audio': 'Áudio',
                'video': 'Vídeo',
                'document': 'Documento'
            };
            return labels[type] || 'Arquivo';
        }

        function updateButton(buttonId, field, value) {
            const button = templateData.buttons.find(btn => btn.id === buttonId);
            if (button) {
                button[field] = value;
            }
        }

        function renderButtons() {
            const buttonsList = document.getElementById('buttonsList');
            buttonsList.innerHTML = '';

            templateData.buttons.forEach((button, index) => {
                // Assign automatic ID based on type
                let autoId = '';
                if (button.type === 'CALL') autoId = '1';
                else if (button.type === 'URL') autoId = '2';
                else if (button.type === 'REPLY') autoId = '3';

                const buttonBlock = document.createElement('div');
                buttonBlock.className = 'button-block';
                buttonBlock.innerHTML = `
                    <div class="button-block-header">
                        <span class="button-block-title">Botão ${index + 1} (ID: ${autoId})</span>
                        <button type="button" class="remove-button" onclick="removeButton(${button.id})">
                            <i data-lucide="trash" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Tipo do Botão</label>
                        <select onchange="updateButton(${button.id}, 'type', this.value)">
                            <option value="REPLY" ${button.type === 'REPLY' ? 'selected' : ''}>Resposta (ID: 3)</option>
                            <option value="URL" ${button.type === 'URL' ? 'selected' : ''}>Link (ID: 2)</option>
                            <option value="CALL" ${button.type === 'CALL' ? 'selected' : ''}>Ligar (ID: 1)</option>
                        </select>
                    </div>
                    ${button.type === 'URL' ? `
                    <div class="form-group">
                        <label>URL</label>
                        <input 
                            type="text" 
                            value="${button.url || ''}"
                            onchange="updateButton(${button.id}, 'url', this.value)"
                            placeholder="Ex: www.xxxx.com"
                        />
                    </div>
                    ` : ''}
                     <div class="form-group">
                        <label>URL</label>
                        <input 
                            type="url" 
                            value="${button.label}"
                            onchange="updateButton(${button.id}, 'url', this.value)"
                            placeholder="Ex: www.xxxx.com"
                        />
                    </div>
                    <div class="form-group">
                        <label>Label do Botão</label>
                        <input 
                            type="text" 
                            value="${button.label}"
                            onchange="updateButton(${button.id}, 'label', this.value)"
                            placeholder="Ex: Sim, quero saber mais"
                        />
                    </div>
                `;
                buttonsList.appendChild(buttonBlock);
            });

            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Save template function
        async function saveTemplate() {
            // Get form data
            templateData.name = document.getElementById('templateName').value.trim();
            templateData.title = document.getElementById('templateTitle').value.trim();
            templateData.message = document.getElementById('templateMessage').value.trim();
            templateData.footer = document.getElementById('templateFooter').value.trim();
            
            // Get profile data
            const profileNameEl = document.getElementById('templateProfileName');
            const profilePhotoEl = document.getElementById('templateProfilePhoto');
            const profileBioEl = document.getElementById('templateProfileBio');
            
            templateData.profile.name = profileNameEl ? profileNameEl.value.trim() : '';
            templateData.profile.photo = profilePhotoEl ? profilePhotoEl.value.trim() : '';
            templateData.profile.bio = profileBioEl ? profileBioEl.value.trim() : '';

            // Get media data
            const mediaType = document.querySelector('input[name="mediaType"]:checked').value;
            const mediaFile = document.getElementById('mediaFile').files[0];
            const mediaUrl = document.getElementById('mediaUrl').value;

            // Validation
            if (!templateData.name || !templateData.message) {
                showNotification('Por favor, preencha o nome e a mensagem do template', 'error');
                return;
            }
            

            // Process buttons with automatic IDs
            const processedButtons = templateData.buttons.map(button => {
                let autoId = '';
                if (button.type === 'CALL') autoId = '1';
                else if (button.type === 'URL') autoId = '2';
                else if (button.type === 'REPLY') autoId = '3';

                const processedButton = {
                    id: autoId,
                    type: button.type,
                    label: button.label
                };

                // Add URL only for URL type buttons
                if (button.type === 'URL' && button.url) {
                    processedButton.url = button.url;
                }

                return processedButton;
            });

            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('name', templateData.name);
                formData.append('title', templateData.title);
                formData.append('message', templateData.message);
                formData.append('footer', templateData.footer);
                formData.append('buttons', JSON.stringify(processedButtons));
                formData.append('profileName', templateData.profile.name);
                formData.append('profilePhoto', templateData.profile.photo);
                formData.append('profileBio', templateData.profile.bio);
                
                // Add media file if selected
                if (mediaType !== 'none' && mediaFile) {
                    formData.append('mediaFile', mediaFile);
                    formData.append('mediaType', mediaType);
                } else if (mediaType === 'image-url' && mediaUrl) {
                    formData.append('mediaType', 'image');
                    formData.append('mediaUrl', mediaUrl);
                } else {
                    formData.append('mediaType', 'none');
                }

                // Send to API
                const response = await fetch('/api/templates', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Template salvo com sucesso!', 'success');
                    closeNewTemplateModal();
                    loadTemplates();
                } else {
                    const error = await response.json();
                    showNotification(`Erro ao salvar template: ${error.error || 'Erro desconhecido'}`, 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Erro ao salvar template. Tente novamente.', 'error');
            }
        }

        // Edit template data
        let editTemplateData = {
            name: '',
            title: '',
            message: '',
            footer: '',
            buttons: [],
            profile: {
                name: '',
                photo: '',
                bio: ''
            }
        };

        function editTemplate(templateId) {
            const template = templatesData.find(t => t.id === templateId);
            if (!template) {
                showNotification('Template não encontrado', 'error');
                return;
            }

            // Set edit template data
            editTemplateData = {
                name: template.name,
                title: template.title || '',
                message: template.message,
                footer: template.footer || '',
                media: template.media || {
                    type: null,
                    url: null,
                    filename: null,
                    size: null
                },
                buttons: template.buttons ? template.buttons.map(btn => ({
                    id: Date.now() + Math.random(), // Generate new temporary ID
                    type: btn.type,
                    label: btn.label,
                    url: btn.url || ''
                })) : [],
                profile: template.profile || {
                    name: '',
                    photo: '',
                    bio: ''
                }
            };

            // Fill form fields
            document.getElementById('editTemplateId').value = templateId;
            document.getElementById('editTemplateName').value = editTemplateData.name;
            document.getElementById('editTemplateTitle').value = editTemplateData.title;
            document.getElementById('editTemplateMessage').value = editTemplateData.message;
            document.getElementById('editTemplateFooter').value = editTemplateData.footer;
            
            // Fill profile fields
            document.getElementById('editTemplateProfileName').value = editTemplateData.profile.name || '';
            document.getElementById('editTemplateProfilePhoto').value = editTemplateData.profile.photo || '';
            document.getElementById('editTemplateProfileBio').value = editTemplateData.profile.bio || '';

            // Fill media fields
            const mediaType = editTemplateData.media?.type || 'none';
            document.querySelector(`input[name="editMediaType"][value="${mediaType}"]`).checked = true;
            
            if (mediaType !== 'none' && editTemplateData.media?.filename) {
                document.getElementById('editMediaFilename').textContent = editTemplateData.media.filename;
                document.getElementById('editMediaSize').textContent = editTemplateData.media.size || '';
                document.getElementById('editMediaPreview').style.display = 'block';
                document.getElementById('editFileUploadArea').style.display = 'none';
                document.getElementById('editMediaUploadSection').style.display = 'block';
            } else {
                document.getElementById('editMediaUploadSection').style.display = 'none';
                document.getElementById('editMediaPreview').style.display = 'none';
            }

            // Trigger media type change to show/hide upload section
            handleEditMediaTypeChange();
            
            // Clear URL field when opening edit modal
            document.getElementById('editMediaUrl').value = '';
            document.getElementById('editMediaUrlPreview').style.display = 'none';

            // Render edit buttons
            renderEditButtons();

            // Show modal
            document.getElementById('editTemplateModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeEditTemplateModal() {
            document.getElementById('editTemplateModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Edit button management functions
        function addEditButton() {
            const buttonId = Date.now();
            editTemplateData.buttons.push({
                id: buttonId,
                type: 'REPLY',
                label: '',
                url: ''
            });
            renderEditButtons();
        }

        function removeEditButton(buttonId) {
            editTemplateData.buttons = editTemplateData.buttons.filter(btn => btn.id !== buttonId);
            renderEditButtons();
        }

        function updateEditButton(buttonId, field, value) {
            const button = editTemplateData.buttons.find(btn => btn.id === buttonId);
            if (button) {
                button[field] = value;
            }
        }

        function renderEditButtons() {
            const buttonsList = document.getElementById('editButtonsList');
            buttonsList.innerHTML = '';

            editTemplateData.buttons.forEach((button, index) => {
                // Assign automatic ID based on type
                let autoId = '';
                if (button.type === 'CALL') autoId = '1';
                else if (button.type === 'URL') autoId = '2';
                else if (button.type === 'REPLY') autoId = '3';

                const buttonBlock = document.createElement('div');
                buttonBlock.className = 'button-block';
                buttonBlock.innerHTML = `
                    <div class="button-block-header">
                        <span class="button-block-title">Botão ${index + 1} (ID: ${autoId})</span>
                        <button type="button" class="remove-button" onclick="removeEditButton(${button.id})">
                            <i data-lucide="trash" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Tipo do Botão</label>
                        <select onchange="updateEditButton(${button.id}, 'type', this.value)">
                            <option value="REPLY" ${button.type === 'REPLY' ? 'selected' : ''}>Resposta (ID: 3)</option>
                            <option value="URL" ${button.type === 'URL' ? 'selected' : ''}>Link (ID: 2)</option>
                            <option value="CALL" ${button.type === 'CALL' ? 'selected' : ''}>Ligar (ID: 1)</option>
                        </select>
                    </div>
                    ${button.type === 'URL' ? `
                    <div class="form-group">
                        <label>URL</label>
                        <input 
                            type="text" 
                            value="${button.url || ''}"
                            onchange="updateEditButton(${button.id}, 'url', this.value)"
                            placeholder="Ex: www.xxxx.com"
                        />
                    </div>
                    ` : ''}
                    <div class="form-group">
                        <label>Label do Botão</label>
                        <input 
                            type="text" 
                            value="${button.label}"
                            onchange="updateEditButton(${button.id}, 'label', this.value)"
                            placeholder="Ex: Sim, quero saber mais"
                        />
                    </div>
                `;
                buttonsList.appendChild(buttonBlock);
            });

            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Update template function
        async function updateTemplate() {
            console.log('🔄 Iniciando atualização do template...');
            
            // Get form data
            editTemplateData.name = document.getElementById('editTemplateName').value.trim();
            editTemplateData.title = document.getElementById('editTemplateTitle').value.trim();
            editTemplateData.message = document.getElementById('editTemplateMessage').value.trim();
            editTemplateData.footer = document.getElementById('editTemplateFooter').value.trim();
            
            // Get profile data
            editTemplateData.profile.name = document.getElementById('editTemplateProfileName').value.trim();
            editTemplateData.profile.photo = document.getElementById('editTemplateProfilePhoto').value.trim();
            editTemplateData.profile.bio = document.getElementById('editTemplateProfileBio').value.trim();

            // Get media data
            const mediaType = document.querySelector('input[name="editMediaType"]:checked').value;
            const mediaFile = document.getElementById('editMediaFile').files[0];
            const mediaUrl = document.getElementById('editMediaUrl').value;
            
            console.log('📝 Dados do template:', {
                name: editTemplateData.name,
                message: editTemplateData.message,
                mediaType: mediaType,
                hasMediaFile: !!mediaFile,
                mediaFile: mediaFile ? {
                    name: mediaFile.name,
                    size: mediaFile.size,
                    type: mediaFile.type
                } : null
            });
            
            // Verificar se o input file está funcionando
            const fileInput = document.getElementById('editMediaFile');
            console.log('📎 Input file element:', {
                exists: !!fileInput,
                files: fileInput ? fileInput.files.length : 0,
                value: fileInput ? fileInput.value : 'N/A'
            });

            // Validation
            if (!editTemplateData.name || !editTemplateData.message) {
                console.log('❌ Validação falhou: nome ou mensagem vazios');
                showNotification('Por favor, preencha o nome e a mensagem do template', 'error');
                return;
            }

            // Process buttons with automatic IDs
            const processedButtons = editTemplateData.buttons.map(button => {
                let autoId = '';
                if (button.type === 'CALL') autoId = '1';
                else if (button.type === 'URL') autoId = '2';
                else if (button.type === 'REPLY') autoId = '3';

                const processedButton = {
                    id: autoId,
                    type: button.type,
                    label: button.label
                };

                // Add URL only for URL type buttons
                if (button.type === 'URL' && button.url) {
                    processedButton.url = button.url;
                }

                return processedButton;
            });

            const templateId = document.getElementById('editTemplateId').value;

            try {
                console.log('📦 Criando FormData...');
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('name', editTemplateData.name);
                formData.append('title', editTemplateData.title);
                formData.append('message', editTemplateData.message);
                formData.append('footer', editTemplateData.footer);
                formData.append('buttons', JSON.stringify(processedButtons));
                formData.append('profileName', editTemplateData.profile.name);
                formData.append('profilePhoto', editTemplateData.profile.photo);
                formData.append('profileBio', editTemplateData.profile.bio);
                
                // Add media file if selected
                if (mediaType !== 'none' && mediaFile) {
                    console.log('📎 Adicionando arquivo de mídia:', mediaFile.name);
                    formData.append('mediaFile', mediaFile);
                    formData.append('mediaType', mediaType);
                } else if (mediaType === 'image-url' && mediaUrl) {
                    console.log('📎 Adicionando URL de imagem:', mediaUrl);
                    formData.append('mediaType', 'image');
                    formData.append('mediaUrl', mediaUrl);
                } else if (mediaType !== 'none' && !mediaFile) {
                    console.log('📎 Tipo de mídia selecionado mas sem arquivo:', mediaType);
                    formData.append('mediaType', mediaType);
                    // Keep existing media if no new file is selected
                    if (editTemplateData.media) {
                        console.log('📎 Mantendo mídia existente:', editTemplateData.media);
                        formData.append('existingMedia', JSON.stringify(editTemplateData.media));
                    }
                } else {
                    console.log('📎 Sem mídia selecionada');
                    formData.append('mediaType', 'none');
                }

                console.log('🚀 Enviando requisição para:', `/api/templates/${templateId}`);
                console.log('📦 FormData contents:', Array.from(formData.entries()));
                
                // Send to API
                const response = await fetch(`/api/templates/${templateId}`, {
                    method: 'PUT',
                    body: formData
                });

                console.log('📡 Resposta recebida:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Template atualizado com sucesso:', result);
                    showNotification('Template atualizado com sucesso!', 'success');
                    closeEditTemplateModal();
                    loadTemplates();
                } else {
                    const error = await response.json();
                    console.log('❌ Erro na resposta:', error);
                    showNotification(`Erro ao atualizar template: ${error.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('💥 Erro na requisição:', error);
                console.error('💥 Stack trace:', error.stack);
                showNotification('Erro ao atualizar template. Tente novamente.', 'error');
            }
        }

        function confirmDeleteTemplate(templateId, templateName) {
            if (confirm(`Tem certeza que deseja excluir o template "${templateName}"?\n\nEsta ação não pode ser desfeita.`)) {
                deleteTemplate(templateId);
            }
        }

        async function deleteTemplate(templateId) {
            try {
                // Send to API
                const response = await fetch(`/api/templates/${templateId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Template excluído com sucesso!', 'success');
                    loadTemplates();
                } else {
                    const error = await response.json();
                    showNotification(`Erro ao excluir template: ${error.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Erro ao excluir template. Tente novamente.', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#00ff88' : type === 'error' ? '#ff4757' : '#00d4ff'};
                color: ${type === 'success' ? '#000' : '#fff'};
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 1001;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
                max-width: 400px;
                font-weight: 500;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Close modals when clicking outside
        document.getElementById('newTemplateModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNewTemplateModal();
            }
        });

        document.getElementById('editTemplateModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditTemplateModal();
            }
        });

        // Close modals with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeNewTemplateModal();
                closeEditTemplateModal();
            }
        });

        // Default templates as fallback
        const defaultTemplates = {
            "templates": [
                {
                    "id": "1757550355786",
                    "name": "teste",
                    "title": "testando",
                    "message": "lorem ipsum dolor sit amet",
                    "footer": "lorem ipsum dolor",
                    "media": {
                        "type": null,
                        "url": null,
                        "filename": null,
                        "size": null
                    },
                    "buttons": [
                        {
                            "id": "2",
                            "type": "URL",
                            "label": "clica aqui",
                            "url": "www.google.com"
                        }
                    ],
                    "createdAt": "2025-09-11T00:25:55.786Z",
                    "updatedAt": "2025-09-11T00:41:49.539Z"
                },
                {
                    "id": "1757556902784",
                    "name": "teste 2",
                    "title": "titulo teste",
                    "message": "mensagem teste",
                    "footer": "rodape de teste",
                    "media": {
                        "type": null,
                        "url": null,
                        "filename": null,
                        "size": null
                    },
                    "buttons": [
                        {
                            "id": "2",
                            "type": "URL",
                            "label": "botão teste",
                            "url": "https://www.youtube.com/watch?v=wNKmYTmRmG4&list=RDwNKmYTmRmG4&start_radio=1"
                        },
                        {
                            "id": "2",
                            "type": "URL",
                            "label": "botão teste 2",
                            "url": "www.xvideos.com"
                        }
                    ],
                    "createdAt": "2025-09-11T02:15:02.784Z",
                    "updatedAt": "2025-09-11T02:47:26.842Z"
                },
                {
                    "id": "1757624533590",
                    "name": "teste com imagem",
                    "title": "mensagem com imagem",
                    "message": "lorem ipsum dolor",
                    "footer": "lorem ipsum dolor sit amet",
                    "media": {
                        "type": null,
                        "url": null,
                        "filename": null,
                        "size": null
                    },
                    "buttons": [
                        {
                            "id": "2",
                            "type": "URL",
                            "label": "clique aqui",
                            "url": "https://www.instagram.com/reels/DOaqXQrACTt"
                        }
                    ],
                    "createdAt": "2025-09-11T21:02:13.590Z",
                    "updatedAt": "2025-09-11T21:02:13.590Z"
                }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load templates directly from API
            loadTemplates();

            // Add event listeners for media functionality
            // Media type change listeners
            document.querySelectorAll('input[name="mediaType"]').forEach(radio => {
                radio.addEventListener('change', handleMediaTypeChange);
            });

            document.querySelectorAll('input[name="editMediaType"]').forEach(radio => {
                radio.addEventListener('change', handleEditMediaTypeChange);
                console.log('🔄 Event listener adicionado para:', radio.value);
            });

            // File input listeners
            document.getElementById('mediaFile').addEventListener('change', handleFileSelect);
            document.getElementById('editMediaFile').addEventListener('change', handleEditFileSelect);
            
            // URL input listeners
            document.getElementById('mediaUrl').addEventListener('input', function() {
                const url = this.value;
                const preview = document.getElementById('mediaUrlPreview');
                const img = document.getElementById('mediaUrlImage');
                
                if (url && url.startsWith('http')) {
                    img.src = url;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });
            
            document.getElementById('editMediaUrl').addEventListener('input', function() {
                const url = this.value;
                const preview = document.getElementById('editMediaUrlPreview');
                const img = document.getElementById('editMediaUrlImage');
                
                if (url && url.startsWith('http')) {
                    img.src = url;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });

            // Drag and drop functionality
            const uploadAreas = ['fileUploadArea', 'editFileUploadArea'];
            uploadAreas.forEach(areaId => {
                const area = document.getElementById(areaId);
                if (area) {
                    area.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        area.classList.add('dragover');
                    });

                    area.addEventListener('dragleave', () => {
                        area.classList.remove('dragover');
                    });

                    area.addEventListener('drop', (e) => {
                        e.preventDefault();
                        area.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            const fileInput = areaId === 'fileUploadArea' ? 'mediaFile' : 'editMediaFile';
                            document.getElementById(fileInput).files = files;
                            
                            const event = new Event('change', { bubbles: true });
                            document.getElementById(fileInput).dispatchEvent(event);
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
